# TaxBridge Production Deployment Guide\n\nThis guide provides comprehensive production deployment instructions for TaxBridge USSD & SMS system.\n\n## ðŸš€ Production Architecture\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  Load Balancer  â”‚â”€â”€â”€â”€â”‚  API Gateway    â”‚â”€â”€â”€â”€â”‚  USSD Gateway   â”‚\nâ”‚  (nginx/HAProxy)â”‚    â”‚  (Rate Limiting) â”‚    â”‚  (Africa's Talking)â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜\n          â”‚                      â”‚                      â”‚\n          â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚\n          â”‚              â”‚   Application Servers  â”‚    â”‚\n          â”‚              â”‚   (Node.js Cluster)   â”‚    â”‚\n          â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚\n          â”‚                          â”‚                  â”‚\n          â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚\n          â”‚              â”‚   Database & Cache      â”‚    â”‚\n          â”‚              â”‚   (PostgreSQL + Redis)  â”‚    â”‚\n          â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚\n          â”‚                                            â”‚\n          â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n          â”‚              â”‚   External Services              â”‚\n          â”‚              â”‚   (SMS Providers, DigiTax,  â”‚\n          â”‚              â”‚    Remita, Monitoring)       â”‚\n          â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n## ðŸ“‹ Prerequisites\n\n### Infrastructure Requirements\n\n- **Minimum**: 2 CPU cores, 4GB RAM, 20GB SSD\n- **Recommended**: 4 CPU cores, 8GB RAM, 50GB SSD\n- **Database**: PostgreSQL 14+ with replication\n- **Cache**: Redis 6+ with persistence\n- **Load Balancer**: nginx or HAProxy\n- **SSL**: Valid SSL certificate (required for production)\n\n### Software Dependencies\n\n```bash\n# Node.js 18+ LTS\nnode --version  # Should be >= 18.0.0\n\n# PostgreSQL 14+\npsql --version\n\n# Redis 6+\nredis-server --version\n\n# nginx (for load balancing)\nnginx -v\n```\n\n## ðŸ”§ Environment Configuration\n\n### Production Environment Variables\n\nCreate `.env.production`:\n\n```bash\n# Core Configuration\nNODE_ENV=production\nPORT=3000\n\n# Database (PostgreSQL)\nDATABASE_URL=postgresql://username:password@localhost:5432/taxbridge_prod\nDATABASE_POOL_MIN=2\nDATABASE_POOL_MAX=10\n\n# Redis Cache\nREDIS_URL=redis://localhost:6379\nREDIS_DB=0\nREDIS_PASSWORD=your_redis_password\n\n# Security\nALLOWED_ORIGINS=https://taxbridge.ng,https://api.taxbridge.ng\nREQUIRE_SMS_SIGNATURE=1\nENABLE_METRICS=true\nMETRICS_INTERVAL=30000\n\n# SMS Providers\nCOMMS_PROVIDER=infobip\nINFOBIP_API_KEY=your_production_api_key\nINFOBIP_API_URL=https://api.infobip.com\nINFOBIP_SIGNATURE_SECRET=your_webhook_secret\nINFOBIP_SENDER=TaxBridge\n\n# Africa's Talking (fallback)\nAT_API_KEY=your_at_api_key\nAT_USERNAME=your_at_username\nAT_SHORTCODE=TaxBridge\n\n# Termii (fallback)\nTERMII_API_KEY=your_termii_api_key\nTERMII_API_URL=https://api.termii.com\nTERMII_SIGNATURE_SECRET=your_termii_secret\nTERMII_SENDER=TaxBridge\n\n# DigiTax Integration\nDIGITAX_API_URL=https://api.digitax.gov.ng\nDIGITAX_API_KEY=your_digitax_api_key\nDIGITAX_HMAC_SECRET=your_digitax_hmac_secret\nDIGITAX_MOCK_MODE=false\n\n# Remita Integration\nREMITA_MERCHANT_ID=your_remita_merchant_id\nREMITA_API_KEY=your_remita_api_key\nREMITA_SERVICE_TYPE_ID=your_service_type_id\nREMITA_API_URL=https://remita.net\n\n# USSD Configuration\nUSSD_SHORTCODE=384*2024#\nUSSD_CALLBACK_URL=https://api.taxbridge.ng/ussd\n\n# Monitoring & Logging\nLOG_LEVEL=info\nENABLE_DEADLINE_REMINDERS=true\nTEST_PHONE_NUMBER=+2348000000000\n\n# Performance\nENABLE_CACHE_WARMUP=true\nCACHE_CLEANUP_INTERVAL=3600000\n```\n\n## ðŸ³ Docker Production Setup\n\n### Docker Compose Production\n\n`docker-compose.prod.yml`:\n\n```yaml\nversion: '3.8'\n\nservices:\n  app:\n    build:\n      context: .\n      dockerfile: Dockerfile.prod\n    restart: unless-stopped\n    environment:\n      - NODE_ENV=production\n    env_file:\n      - .env.production\n    ports:\n      - \"3000:3000\"\n    depends_on:\n      - postgres\n      - redis\n    networks:\n      - taxbridge-network\n    deploy:\n      replicas: 2\n      resources:\n        limits:\n          cpus: '1.0'\n          memory: 2G\n        reservations:\n          cpus: '0.5'\n          memory: 1G\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"-f\", \"http://localhost:3000/health\"]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n      start_period: 40s\n\n  postgres:\n    image: postgres:15-alpine\n    restart: unless-stopped\n    environment:\n      POSTGRES_DB: taxbridge_prod\n      POSTGRES_USER: taxbridge_user\n      POSTGRES_PASSWORD: ${DB_PASSWORD}\n    volumes:\n      - postgres_data:/var/lib/postgresql/data\n      - ./backups:/backups\n    networks:\n      - taxbridge-network\n    deploy:\n      resources:\n        limits:\n          cpus: '2.0'\n          memory: 4G\n        reservations:\n          cpus: '1.0'\n          memory: 2G\n\n  redis:\n    image: redis:7-alpine\n    restart: unless-stopped\n    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes\n    volumes:\n      - redis_data:/data\n      - ./redis.conf:/usr/local/etc/redis/redis.conf\n    networks:\n      - taxbridge-network\n    deploy:\n      resources:\n        limits:\n          cpus: '0.5'\n          memory: 1G\n        reservations:\n          cpus: '0.25'\n          memory: 512M\n\n  nginx:\n    image: nginx:alpine\n    restart: unless-stopped\n    ports:\n      - \"80:80\"\n      - \"443:443\"\n    volumes:\n      - ./nginx/nginx.conf:/etc/nginx/nginx.conf\n      - ./ssl:/etc/nginx/ssl\n    depends_on:\n      - app\n    networks:\n      - taxbridge-network\n\nvolumes:\n  postgres_data:\n  redis_data:\n\nnetworks:\n  taxbridge-network:\n    driver: bridge\n```\n\n### Production Dockerfile\n\n`Dockerfile.prod`:\n\n```dockerfile\nFROM node:18-alpine AS builder\n\nWORKDIR /app\n\n# Copy package files\nCOPY package*.json ./\nRUN npm ci --only=production\n\n# Copy source code\nCOPY . .\n\n# Build application\nRUN npm run build\n\n# Production stage\nFROM node:18-alpine AS production\n\n# Install dumb-init for proper signal handling\nRUN apk add --no-cache dumb-init\n\n# Create non-root user\nRUN addgroup -g 1001 -S nodejs\nRUN adduser -S taxbridge -u 1001\n\nWORKDIR /app\n\n# Copy built application\nCOPY --from=builder --chown=taxbridge:nodejs /app/dist ./dist\nCOPY --from=builder --chown=taxbridge:nodejs /app/node_modules ./node_modules\nCOPY --from=builder --chown=taxbridge:nodejs /app/package.json ./package.json\n\n# Create logs directory\nRUN mkdir -p /app/logs && chown taxbridge:nodejs /app/logs\n\nUSER taxbridge\n\nEXPOSE 3000\n\n# Health check\nHEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \\\n  CMD curl -f http://localhost:3000/health || exit 1\n\n# Use dumb-init to handle signals properly\nENTRYPOINT [\"dumb-init\", \"--\"]\nCMD [\"node\", \"dist/src/server.js\"]\n```\n\n## ðŸŒ Nginx Configuration\n\n`nginx/nginx.conf`:\n\n```nginx\nupstream taxbridge_backend {\n    server app1:3000 weight=3 max_fails=3 fail_timeout=30s;\n    server app2:3000 weight=3 max_fails=3 fail_timeout=30s;\n    keepalive 32;\n}\n\n# Rate limiting\nlimit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;\nlimit_req_zone $binary_remote_addr zone=ussd:10m rate=5r/s;\nlimit_req_zone $binary_remote_addr zone=sms:10m rate=3r/s;\n\nserver {\n    listen 80;\n    listen 443 ssl http2;\n    server_name taxbridge.ng api.taxbridge.ng;\n\n    # SSL Configuration\n    ssl_certificate /etc/nginx/ssl/taxbridge.crt;\n    ssl_certificate_key /etc/nginx/ssl/taxbridge.key;\n    ssl_protocols TLSv1.2 TLSv1.3;\n    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256;\n    ssl_prefer_server_ciphers off;\n\n    # Security headers\n    add_header X-Frame-Options DENY;\n    add_header X-Content-Type-Options nosniff;\n    add_header X-XSS-Protection \"1; mode=block\";\n    add_header Strict-Transport-Security \"max-age=31536000; includeSubDomains\" always;\n\n    # API routes with rate limiting\n    location /api/ {\n        limit_req zone=api burst=20 nodelay;\n        proxy_pass http://taxbridge_backend;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_connect_timeout 30s;\n        proxy_send_timeout 30s;\n    }\n\n    # USSD endpoint with stricter rate limiting\n    location /ussd {\n        limit_req zone=ussd burst=10 nodelay;\n        proxy_pass http://taxbridge_backend;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n\n    # SMS webhook with rate limiting\n    location /webhooks/sms {\n        limit_req zone=sms burst=5 nodelay;\n        proxy_pass http://taxbridge_backend;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n\n    # Health checks (no rate limiting)\n    location /health {\n        proxy_pass http://taxbridge_backend;\n        access_log off;\n    }\n\n    location /ready {\n        proxy_pass http://taxbridge_backend;\n        access_log off;\n    }\n\n    # Static assets and monitoring\n    location /metrics {\n        proxy_pass http://taxbridge_backend;\n        allow 127.0.0.1; # Only allow internal monitoring\n        deny all;\n    }\n}\n```\n\n## ðŸš€ Deployment Steps\n\n### 1. Prepare Production Environment\n\n```bash\n# Clone repository\ngit clone https://github.com/your-org/taxbridge.git\ncd taxbridge\n\n# Create production environment file\ncp .env.example .env.production\n# Edit .env.production with your production values\n```\n\n### 2. Build and Deploy\n\n```bash\n# Build Docker images\ndocker-compose -f docker-compose.prod.yml build\n\n# Start services\ndocker-compose -f docker-compose.prod.yml up -d\n\n# Check service status\ndocker-compose -f docker-compose.prod.yml ps\n\n# View logs\ndocker-compose -f docker-compose.prod.yml logs -f app\n```\n\n### 3. Database Migration\n\n```bash\n# Run database migrations\ndocker-compose -f docker-compose.prod.yml exec app npm run prisma:migrate\n\n# Generate Prisma client\ndocker-compose -f docker-compose.prod.yml exec app npm run prisma:generate\n```\n\n### 4. SSL Certificate Setup\n\n```bash\n# Using Let's Encrypt (recommended)\nsudo certbot --nginx -d taxbridge.ng -d api.taxbridge.ng\n\n# Or use your own certificates\nsudo mkdir -p /etc/nginx/ssl\nsudo cp your-cert.crt /etc/nginx/ssl/taxbridge.crt\nsudo cp your-key.key /etc/nginx/ssl/taxbridge.key\n```\n\n## ðŸ” Monitoring and Logging\n\n### Application Monitoring\n\n```bash\n# Health checks\ncurl https://api.taxbridge.ng/health\ncurl https://api.taxbridge.ng/ready\ncurl https://api.taxbridge.ng/metrics\n\n# Log aggregation\ndocker-compose -f docker-compose.prod.yml logs -f app | grep ERROR\n```\n\n### System Monitoring\n\n```bash\n# Resource usage\ndocker stats\n\n# Disk usage\ndf -h\n\n# Memory usage\nfree -h\n\n# Process monitoring\nps aux | grep node\n```\n\n## ðŸ”’ Security Checklist\n\n### âœ… Pre-Deployment Security\n\n- [ ] Environment variables are properly set\n- [ ] SSL certificates are valid and not expired\n- [ ] Database credentials are secure\n- [ ] Redis has password authentication\n- [ ] API keys are rotated and secure\n- [ ] Firewall rules are configured\n- [ ] Rate limiting is enabled\n- [ ] Security headers are configured\n- [ ] CORS is properly configured\n\n### âœ… Post-Deployment Security\n\n- [ ] SSL/TLS is working (https://)\n- [ ] Security headers are present\n- [ ] Rate limiting is functional\n- [ ] Database connections are encrypted\n- [ ] Redis connections are authenticated\n- [ ] Error pages don't leak information\n- [ ] Monitoring endpoints are restricted\n\n## ðŸ“Š Performance Optimization\n\n### Database Optimization\n\n```sql\n-- Create indexes for performance\nCREATE INDEX CONCURRENTLY IF NOT EXISTS idx_users_phone ON users(phone);\nCREATE INDEX CONCURRENTLY IF NOT EXISTS idx_users_nin ON users(nin);\nCREATE INDEX CONCURRENTLY IF NOT EXISTS idx_invoices_user_id ON invoices(user_id);\nCREATE INDEX CONCURRENTLY IF NOT EXISTS idx_invoices_status ON invoices(status);\nCREATE INDEX CONCURRENTLY IF NOT EXISTS idx_payments_rrr ON payments(rrr);\nCREATE INDEX CONCURRENTLY IF NOT EXISTS idx_sms_deliveries_to ON sms_deliveries(to);\nCREATE INDEX CONCURRENTLY IF NOT EXISTS idx_audit_logs_created_at ON audit_logs(created_at);\n```\n\n### Redis Configuration\n\n`redis.conf`:\n\n```conf\n# Memory optimization\nmaxmemory 1gb\nmaxmemory-policy allkeys-lru\n\n# Persistence\nsave 900 1\nsave 300 10\nsave 60 10000\n\n# Security\nrequirepass your_redis_password\nrename-command FLUSH \"\"\nrename-command CONFIG \"\"\nrename-command DEBUG \"\"\n\n# Performance\ntcp-keepalive 300\ntimeout 0\n```\n\n## ðŸ”„ CI/CD Pipeline\n\n### GitHub Actions Workflow\n\n`.github/workflows/production.yml`:\n\n```yaml\nname: Production Deploy\n\non:\n  push:\n    branches: [main]\n  workflow_dispatch:\n\njobs:\n  deploy:\n    runs-on: ubuntu-latest\n    environment: production\n    \n    steps:\n    - uses: actions/checkout@v3\n    \n    - name: Setup Node.js\n      uses: actions/setup-node@v3\n      with:\n        node-version: '18'\n        cache: 'npm'\n    \n    - name: Configure AWS CLI\n      uses: aws-actions/configure-aws-credentials@v1\n      with:\n        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}\n        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}\n        aws-region: us-east-1\n    \n    - name: Deploy to EC2\n      run: |\n        # Deploy to production server\n        aws s3 sync ./ s3://taxbridge-deploy/\n        \n        # Trigger deployment on server\n        ssh -o StrictHostKeyChecking=no ec2-user@your-server.com '\n          cd /opt/taxbridge &&\n          docker-compose -f docker-compose.prod.yml pull &&\n          docker-compose -f docker-compose.prod.yml up -d &&\n          docker-compose -f docker-compose.prod.yml exec app npm run prisma:migrate\n        '\n```\n\n## ðŸš¨ Troubleshooting\n\n### Common Issues\n\n1. **Database Connection Failed**\n   ```bash\n   # Check database connectivity\n   docker-compose -f docker-compose.prod.yml exec app npm run db:check\n   \n   # Check database logs\n   docker-compose -f docker-compose.prod.yml logs postgres\n   ```\n\n2. **SMS Not Sending**\n   ```bash\n   # Check SMS provider configuration\n   curl -X POST https://api.taxbridge.ng/metrics | jq '.sms'\n   \n   # Test SMS provider directly\n   docker-compose -f docker-compose.prod.yml exec app npm run sms:test\n   ```\n\n3. **High Memory Usage**\n   ```bash\n   # Check memory usage\n   docker stats\n   \n   # Restart services if needed\n   docker-compose -f docker-compose.prod.yml restart app\n   ```\n\n4. **SSL Certificate Issues**\n   ```bash\n   # Check SSL certificate\n   openssl x509 -in /etc/nginx/ssl/taxbridge.crt -text -noout\n   \n   # Test SSL configuration\n   nginx -t\n   ```\n\n### Emergency Procedures\n\n1. **Service Down**\n   ```bash\n   # Quick restart\n   docker-compose -f docker-compose.prod.yml restart\n   \n   # Check logs\n   docker-compose -f docker-compose.prod.yml logs --tail=100\n   ```\n\n2. **Database Issues**\n   ```bash\n   # Switch to read-only mode\n   echo \"NODE_ENV=production\" >> .env.production\n   echo \"DATABASE_READ_ONLY=true\" >> .env.production\n   \n   # Restart with read-only\n   docker-compose -f docker-compose.prod.yml restart app\n   ```\n\n3. **SMS Provider Outage**\n   ```bash\n   # Check provider health\n   curl https://api.taxbridge.ng/metrics | jq '.sms.providers'\n   \n   # Force switch to backup provider\n   curl -X POST https://api.taxbridge.ng/admin/sms/switch \\\n     -H \"Authorization: Bearer $ADMIN_TOKEN\" \\\n     -d '{\"provider\": \"termii\"}'\n   ```\n\n## ðŸ“ˆ Scaling Guidelines\n\n### Horizontal Scaling\n\n- **App Servers**: Add more instances to upstream\n- **Database**: Use read replicas for scaling reads\n- **Redis**: Use Redis Cluster for large scale\n- **Load Balancer**: Add more nginx instances\n\n### Vertical Scaling\n\n- **CPU**: Increase CPU allocation\n- **Memory**: Increase RAM allocation\n- **Storage**: Use faster SSD storage\n- **Network**: Increase bandwidth allocation\n\n## ðŸ“ž Support and Maintenance\n\n### Monitoring Contacts\n\n- **Technical Lead**: +234-800-000-0001\n- **DevOps**: +234-800-000-0002\n- **Security**: +234-800-000-0003\n\n### Maintenance Windows\n\n- **Regular**: Every Sunday 2:00 AM - 4:00 AM WAT\n- **Emergency**: As needed with 24-hour notice\n- **Updates**: First Tuesday of every month\n\n### Backup Strategy\n\n- **Database**: Daily full backups + hourly incremental\n- **Files**: Real-time replication to backup server\n- **Configuration**: Version-controlled in Git\n- **Recovery**: RTO: 4 hours, RPO: 1 hour\n\n---\n\n**Last Updated**: January 2026\n**Version**: 1.0.0\n**Environment**: Production\n\nFor support, contact: devops@taxbridge.ng
